<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='Content-type' content='text/html; charset=utf-8'>
    <title>Movie Exploration</title>
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/transition.css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.js"></script>
  </head>
  <body>
    <h1>Movies!</h1>
    <div id="container">
      <p>
        If you can see this, React is not working right.
        If you checked out the source from GitHub make sure to run <code>grunt</code>.
      </p>
    </div>
    <script src="js/es5-shim.min.js"></script>
    <script src="js/es5-sham.min.js"></script>
    <script src="js/console-polyfill.js"></script>
    <script src="js/react-with-addons.js"></script>
    <script src="js/JSXTransformer.js"></script>
    <script type="text/jsx">
      var CSSTransitionGroup = React.addons.CSSTransitionGroup;
      var INTERVAL = 2000;

      var MovieRequest = React.createClass({
        handleSubmit: function(event) {
          this.props.reset_state();
          event.preventDefault();

          // Really want to store this in state instead
          // TODO: I'll pretty much have to do that when I add the
          // <Enter> handler to the text box
          var name = $("#name").val();
          if(name.length != 0) {
            console.log("Querying for ", name);
            $.ajax({
              url: "http://omdbapi.com",
              data: {s: name},
              type: "GET",
              dataType: "json",

              success: function(json) {
                console.log("Received:", json);
	        // Here we have the AJAX object.
	        console.log("In current scope, this looks like:", this);
	        if(this.isMounted()) {
                  var movies = json["Search"];
                  if(movies) {
                    console.log("Updating movie list with", movies);
                    this.props.update_base_list(movies);
                    console.log("State change scheduled");
                  }
	          else {
	            console.log("No results found");
	          }
                }
	        else {
	          console.warn("Component unmounted before result returned");
	        }
              }.bind(this),
              error: function(xhr, status, err) {
                // Of course, by the time we get here, the state name could
                // definitely have changes
                console.error(this.state.name, status, err.toString());
              }.bind(this)
            });
          } else {
            console.log("Nothing to query for");
          }
        },

        getInitialState: function() {
          return {"name": ""};
        },

        render: function() {
          // TODO: should also submit if <Enter> is pressed when name has focus
          return (
              <div key="submission-form">
                <input type="text" id="name" placeholder="Movie Name" />
                <input type="button" value="Search" onClick={this.handleSubmit} />
	      </div>
          );
        }
      });

      var MovieDetail = React.createClass({
        render: function() {
          // TODO: I should have a lot more details available very shortly
          return(<div key={this.props.movie.imdbID}>{this.props.movie.title} - {this.props.movie.year}</div>);
        }
      });

      var MovieDetailList = React.createClass({
        render: function() {
	      /*var movieNodes = {}
	      for(n in this.props.data) {
	        movieNodes[n] = this.props.data[n];
	      }
              var children = React.addons.createFragment(movieNodes);*/
            var movieNodes = this.props.data.map(function(movie) {
            return (
              <MovieDetail movie={movie} />
            );
          });
          return (
            <div key="detail-list" className="movieList">{movieNodes}</div>
          );
        }
      });

      var MovieDetails = React.createClass({
        resetState: function() {
	    this.replaceState({});
        },
        updateBaseList: function(movies) {
          console.log("Have movies. Scheduling state change through " + this);
          
          var description = {};
          for(var n in movies) {
            var movie = movies[n];
            console.log("Adding to base state:", movie);
            var title = movie["Title"];
            var key = movie["imdbID"];
            description[key] = {"title": title,
                                "key": key,
                                "year": movie["Year"]
                               };
            console.log("Not querying for details about " + title);
            /* Don't do this yet: get the initial piece working
            $.ajax({
              url: "http://omdbapi.com",
              data: {i: key,
                     tomatoes: true},
              dataType: "json",
              success: function(details) {
                console.log("Detail Received:", details);
                console.log("Component:", component);
                if(this.isMounted()) {
                  var key2 = details["imdbID"];
                  if(key != key2) {
                    console.error("Querying for " + key + " returned " + key2);
                  }
	          details["key"] = key;
                  this.setState({key: details});
                }
                else {
                  console.log("Component unmounted from underneath us");
                }
              }.bind(this),
              error: function(xhr, status, err) {
                console.error(xhr, status, err);
              }.bind(this)
            }); */
          };
          console.log("Getting ready to change the state to", description);
          this.replaceState(description);
        },

        getInitialState: function() {
          return {};
        },

        /*componentDidMount: function() {
          this.interval = setInterval(this.tick, INTERVAL);
        },

        componentWillUnmount: function() {
          clearInterval(this.interval);
        },

        tick: function() {
          this.setState({start: this.state.start + 1});
        },*/

        render: function() {
          movies = [];
          if(this.state){
            console.log("Rendering:", this.state);
            for(var key in this.state) {
              movie = this.state[key];
              movies.push(movie);
            };
          }
	    /* Really want to involve something along these lines:
              <CSSTransitionGroup
                className="animateExample"
                transitionName="example">
                {movies}
              </CSSTransitionGroup> */
          return(
            <div>
              <MovieRequest key="request-form" update_base_list={this.updateBaseList} reset_state={this.resetState} />
              <MovieDetailList key="outer-list" data={movies} />
            </div>
          );
	}
      });

      React.render(
        <MovieDetails />,
        document.getElementById("container")
      );
    </script>
  </body>
</html>
