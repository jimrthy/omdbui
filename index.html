<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='Content-type' content='text/html; charset=utf-8'>
    <title>Movie Exploration</title>
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/transition.css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  </head>
  <body>
    <h1>Movies!</h1>
    <div id="place-holder">
      <div id="container">
	<p>
          If you can see this, React is not working right.
          If you checked out the source from GitHub make sure to run <code>grunt</code>.
	</p>
      </div>
    </div>
    <script src="js/es5-shim.min.js"></script>
    <script src="js/es5-sham.min.js"></script>
    <script src="js/console-polyfill.js"></script>
    <script src="js/react-with-addons.js"></script>
    <script src="js/JSXTransformer.js"></script>
    <script type="text/jsx">
      var CSSTransitionGroup = React.addons.CSSTransitionGroup;
      var INTERVAL = 2000;

      var MovieRequest = React.createClass({
        getInitialState: function() {
          return {"name": ""};
        },
        render: function() {
          return (
              <form onSubmit={this.props.submitter}>
                <input type="text" id="name" placeholder="Movie Name" />
                <input type="submit" value="Search" />
	      </form>
          );
        }
      });

      var MovieDetails = React.createClass({
        getInitialState: function() {
          return {};
        },

        /*componentDidMount: function() {
          this.interval = setInterval(this.tick, INTERVAL);
        },

        componentWillUnmount: function() {
          clearInterval(this.interval);
        },

        tick: function() {
          this.setState({start: this.state.start + 1});
        },*/

        handleSubmit: function(event) {
          event.preventDefault();
          this.setState({});

	  // TODO: I'm almost positive I want to pull this from the Component instead
          name = $("#name").val();
          if(name.length != 0) {
            $.ajax({
              url: "http://omdbapi.com",
              data: {s: name},
              type: "GET",
              dataType: "json",

              success: function(json) {
                console.log("Received:\n" + json);
                var movies = json["Search"];
                if(movies) {
                  this.replaceState(function(previousState, currentProps) {
	            var description = {};
                    for(var movie in movies) {
	              var title = movie["Title"];
                      description[movie["imdbID"]] = {"title": title,
                                                      "year": movie["Year"]
                                                     };
	              $.ajax({
	                url: "http://omdbapi.com",
	                data: {t: title,
	                       tomatoes: true},
	                dataType: "json",
	                success: function(details) {
	                  this.setState(function(previousState, currentProps) {
	                    var nextState = previousState.clone();
	                    var _id = json["imdbID"];
	                    nextState[_id] = details;
	                    return nextState;
	                  });
	                }
	              });
                    };
	            return description;
                  });
                }
              }
            });
          }
        },

        render: function() {
          result = [];
          if(this.state){
            console.log(this.state);
            for(var key in this.state) {
              movie = this.state[key];
              result.push(<div>{movie.Title} - {movie.Year}</div>);
            };
          }
          return(
            <div>
	      <MovieRequest submitter={this.handleSubmit} />
              <CSSTransitionGroup
                className="animateExample"
                transitionName="example">
                {result}
              </CSSTransitionGroup>
            </div>
          );
	}
      });

      React.render(
        <MovieDetails />,
        document.getElementById('place-holder')
      );
    </script>
  </body>
</html>
